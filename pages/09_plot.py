import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from firebase_config import get_firebase_ref
from SP_utils import sanitize_key
from Home import check_participant

# ================================
# Configuration
# ================================

# Experiment numbers mapping
EXPERIMENTS = {
    'MDD': {
        'gptsmall_basic': [(6201, 1111), (6201, 1112)],
        'gptsmall_guided': [(6201, 2111), (6201, 2112)],
        'gptsmaller_guided': [(6201, 3111), (6201, 3114)],
        'gptlarge_guided': [(6201, 1121), (6201, 1122)],
        'claudesmall_basic': [(6201, 1131), (6201, 1132)],
        'claudesmall_guided': [(6201, 2131), (6201, 2132)],
        'claudesmaller_guided': [(6201, 3131), (6201, 3132)],
        'claudelarge_guided': [(6201, 1141), (6201, 1142)],
    },
    'BD': {
        'gptsmall_basic': [(6202, 1211), (6202, 1212)],
        'gptsmall_guided': [(6202, 2211), (6202, 2212)],
        'gptsmaller_guided': [(6202, 3211), (6202, 3212)],
        'gptlarge_guided': [(6202, 1221), (6202, 1222)],
        'claudesmall_basic': [(6202, 1231), (6202, 1232)],
        'claudesmall_guided': [(6202, 2231), (6202, 2232)],
        'claudesmaller_guided': [(6202, 3231), (6202, 3232)],
        'claudelarge_guided': [(6202, 1241), (6202, 1242)],
    },
    'OCD': {
        'gptsmall_basic': [(6206, 1611), (6206, 1612)],
        'gptsmall_guided': [(6206, 2611), (6206, 2612)],
        'gptsmaller_guided': [(6206, 3611), (6206, 3612)],
        'gptlarge_guided': [(6206, 1621), (6206, 1622)],
        'claudesmall_basic': [(6206, 1631), (6206, 1632)],
        'claudesmall_guided': [(6206, 2631), (6206, 2632)],
        'claudesmaller_guided': [(6206, 3631), (6206, 3632)],
        'claudelarge_guided': [(6206, 1641), (6206, 1642)],
    }
}

# Color mapping for disorders
DISORDER_COLORS = {
    'MDD': '#E63946',  # Dark Red
    'BD': '#06D6A0',   # Dark Teal
    'OCD': '#FFB703',  # Dark Orange/Yellow
}

# Marker shapes and fill styles for models
MARKER_CONFIG = {
    'gptsmall_basic': {'marker': 'o', 'fill': 'empty'},           # Empty circle
    'gptsmall_guided': {'marker': 'o', 'fill': 'filled'},         # Filled circle
    'gptsmaller_guided': {'marker': 'o', 'fill': 'empty_hatched'}, # Empty circle with hatch
    'gptlarge_guided': {'marker': 'o', 'fill': 'filled_hatched'}, # Filled circle with hatch
    'claudesmall_basic': {'marker': 's', 'fill': 'empty'},        # Empty square
    'claudesmall_guided': {'marker': 's', 'fill': 'filled'},      # Filled square
    'claudesmaller_guided': {'marker': 's', 'fill': 'empty_hatched'}, # Empty square with hatch
    'claudelarge_guided': {'marker': 's', 'fill': 'filled_hatched'}, # Filled square with hatch
}

# Model display names
MODEL_NAMES = {
    'gptsmall_basic': 'GPT-Small + Basic',
    'gptsmall_guided': 'GPT-Small + Guided',
    'gptsmaller_guided': 'GPT-Smaller + Guided',
    'gptlarge_guided': 'GPT-Large + Guided',
    'claudesmall_basic': 'Claude-Small + Basic',
    'claudesmall_guided': 'Claude-Small + Guided',
    'claudesmaller_guided': 'Claude-Smaller + Guided',
    'claudelarge_guided': 'Claude-Large + Guided',
}


# ================================
# Data Loading Functions
# ================================

def load_psyche_scores(firebase_ref):
    """Load PSYCHE scores from Firebase for all experiments
    
    PSYCHE scores are generated by the Evaluation page (ì—°êµ¬ììš© ê²©ë¦¬ í´ë”) 
    and saved with key pattern: clients_{client_number}_psyche_{diagnosis}_{model}_{exp_number}
    at the root level of Firebase (not nested under clients/)
    """
    scores_data = []
    
    # Get all data from Firebase root
    try:
        all_data = firebase_ref.get()
        if not all_data:
            return scores_data
        
        # Search through all keys for psyche evaluation data
        for key in all_data.keys():
            # Key format: clients_{client_number}_psyche_{diagnosis}_{model}_{exp_number}
            if "_psyche_" in key and key.startswith("clients_"):
                # Parse the key
                parts = key.split("_")
                # Expected: ['clients', '{client_num}', 'psyche', '{diagnosis}', '{model}', '{exp_num}']
                if len(parts) >= 6 and parts[2] == "psyche":
                    client_num = int(parts[1])
                    exp_num = int(parts[5])
                    
                    # Find which disorder and model_type this exp_num belongs to
                    # exp_num is unique, so we can just search for it
                    found = False
                    for diagnosis, models in EXPERIMENTS.items():
                        for model_type, exp_list in models.items():
                            if (client_num, exp_num) in exp_list:
                                found = True
                                break
                        if found:
                            break
                    
                    if found:
                            # Load the data
                            data = firebase_ref.child(key).get()
                            if data and 'psyche_score' in data:
                                scores_data.append({
                                    'disorder': diagnosis,
                                    'model': model_type,
                                    'client_num': client_num,
                                    'exp_num': exp_num,
                                    'psyche_score': data['psyche_score']
                                })
    
    except Exception as e:
        st.error(f"Error loading PSYCHE scores: {e}")
        import traceback
        st.code(traceback.format_exc())
    
    return scores_data


# ================================
# Plotting Function
# ================================

def create_psyche_plot(scores_data):
    """Create a matplotlib scatter plot on a single axis (PSYCHE score)"""
    
    fig, ax = plt.subplots(figsize=(14, 8), facecolor='black')
    ax.set_facecolor('black')
    
    # Track which models have been added to legend
    added_models = set()
    
    # Y-axis positions for disorder + model family combinations
    y_positions = {
        ('MDD', 'gpt'): 2.5,
        ('MDD', 'claude'): 1.7,
        ('BD', 'gpt'): 0.7,
        ('BD', 'claude'): -0.1,
        ('OCD', 'gpt'): -1.1,
        ('OCD', 'claude'): -1.9,
    }
    
    # Plot each disorder-model combination
    for disorder in ['MDD', 'BD', 'OCD']:
        for model_type in ['gptsmall_basic', 'gptsmall_guided', 'gptsmaller_guided', 'gptlarge_guided', 
                           'claudesmall_basic', 'claudesmall_guided', 'claudesmaller_guided', 'claudelarge_guided']:
            # Filter data
            filtered = [s for s in scores_data 
                       if s['disorder'] == disorder and s['model'] == model_type]
            
            if not filtered:
                continue
            
            # Extract scores
            scores = [s['psyche_score'] for s in filtered]
            
            # Determine model family (gpt or claude)
            model_family = 'gpt' if 'gpt' in model_type else 'claude'
            
            # Y-axis position for this disorder+model_family combination
            # All models in same family on same line with minimal jitter
            base_y = y_positions[(disorder, model_family)]
            y_values = [base_y + np.random.uniform(-0.02, 0.02) for _ in scores]
            
            # Only add to legend once per model (first disorder)
            label = MODEL_NAMES[model_type] if model_type not in added_models else None
            if label:
                added_models.add(model_type)
            
            # Get marker configuration
            config = MARKER_CONFIG[model_type]
            marker = config['marker']
            fill_style = config['fill']
            
            # Set fill properties based on style
            if fill_style == 'empty':
                # Empty marker - no fill, just edge
                facecolor = 'none'
                edgecolor = DISORDER_COLORS[disorder]
                hatch = None
                alpha = 1.0
            elif fill_style == 'filled':
                # Filled marker
                facecolor = DISORDER_COLORS[disorder]
                edgecolor = 'white'
                hatch = None
                alpha = 0.9
            elif fill_style == 'empty_hatched':
                # Empty marker with hatch
                facecolor = 'none'
                edgecolor = DISORDER_COLORS[disorder]
                hatch = '///'
                alpha = 1.0
            else:  # filled_hatched
                # Filled marker with hatch
                facecolor = DISORDER_COLORS[disorder]
                edgecolor = 'white'
                hatch = '///'
                alpha = 0.7
            
            # Plot
            ax.scatter(
                scores,
                y_values,
                marker=marker,
                s=150,  # size - reduced for better visibility
                facecolors=facecolor,
                edgecolors=edgecolor,
                linewidths=1.5,
                hatch=hatch,
                alpha=alpha,
                label=label
            )
    
    # Styling
    ax.set_xlabel('PSYCHE Score', fontsize=14, fontweight='bold', color='white')
    ax.set_title('PACA Performance: PSYCHE Scores by Disorder and Model', 
                 fontsize=16, fontweight='bold', pad=20, color='white')
    
    # Y-axis with disorder + model family labels
    y_ticks = [2.5, 1.7, 0.7, -0.1, -1.1, -1.9]
    y_labels = [
        'MDD Ã— GPT',
        'MDD Ã— Claude',
        'BD Ã— GPT',
        'BD Ã— Claude',
        'OCD Ã— GPT',
        'OCD Ã— Claude'
    ]
    ax.set_yticks(y_ticks)
    ax.set_yticklabels(y_labels, fontsize=10, color='white')
    ax.set_ylabel('')
    
    # Grid
    ax.grid(True, axis='x', alpha=0.2, linestyle='--', color='gray')
    ax.grid(True, axis='y', alpha=0.1, linestyle='-', color='gray')
    ax.set_ylim(-2.4, 3.0)
    
    # Set x-axis range and styling
    if scores_data:
        max_score = max([s['psyche_score'] for s in scores_data])
        ax.set_xlim(0, max(max_score * 1.1, 55))  # At least show full range to max possible (55)
    else:
        ax.set_xlim(0, 55)  # Max possible PSYCHE score
    
    ax.tick_params(colors='white', labelsize=11)
    
    # Simplified legend for models
    legend1 = ax.legend(title='Models', title_fontsize=11, fontsize=10,
                       loc='upper left', frameon=True, facecolor='#1a1a1a',
                       edgecolor='white', labelcolor='white')
    legend1.get_title().set_color('white')
    
    # Add color legend for disorders manually
    from matplotlib.patches import Patch
    disorder_patches = [Patch(facecolor=DISORDER_COLORS['MDD'], label='MDD'),
                       Patch(facecolor=DISORDER_COLORS['BD'], label='BD'),
                       Patch(facecolor=DISORDER_COLORS['OCD'], label='OCD')]
    legend2 = ax.legend(handles=disorder_patches, title='Disorders', title_fontsize=11, fontsize=10,
                       loc='lower left', frameon=True, facecolor='#1a1a1a',
                       edgecolor='white', labelcolor='white')
    legend2.get_title().set_color('white')
    
    # Add first legend back (matplotlib removes previous legend when adding new one)
    ax.add_artist(legend1)
    
    # Remove spines
    ax.spines['top'].set_visible(False)
    ax.spines['right'].set_visible(False)
    ax.spines['left'].set_visible(False)
    ax.spines['bottom'].set_color('white')
    
    plt.tight_layout()
    
    return fig


# ================================
# Main Page
# ================================

def main():
    st.set_page_config(
        page_title="PSYCHE Score Plot",
        page_icon="ğŸ“Š",
        layout="wide"
    )
    
    # Check authentication
    if not check_participant():
        st.stop()
    
    # Firebase connection
    firebase_ref = get_firebase_ref()
    if firebase_ref is None:
        st.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨")
        st.stop()
    
    # Page Header
    st.title("ğŸ“Š PACA Performance Visualization")
    st.markdown("---")
    
    # Info box
    with st.expander("â„¹ï¸ ê·¸ë˜í”„ ì„¤ëª…", expanded=True):
        st.markdown("""
        ì´ ê·¸ë˜í”„ëŠ” **PACA(Psychiatric Assessment Conversational Agent)**ì˜ ì„±ëŠ¥ì„ 
        **PSYCHE Score**ë¡œ ì‹œê°í™”í•œ ê²ƒì…ë‹ˆë‹¤.
        
        ### êµ¬ì„± ìš”ì†Œ:
        
        **ìƒ‰ìƒ (ì§ˆí™˜)**:
        - ğŸ”´ **ë¹¨ê°•**: Major Depressive Disorder (MDD)
        - ğŸ”µ **ì²­ë¡ìƒ‰**: Bipolar Disorder (BD)
        - ğŸŸ¡ **ë…¸ë‘**: Obsessive-Compulsive Disorder (OCD)
        
        **ëª¨ì–‘ ë° íŒ¨í„´ (ëª¨ë¸)**:
        - **ë™ê·¸ë¼ë¯¸ (GPT ê³„ì—´)**:
          - â—‹ ë¹ˆ ë™ê·¸ë¼ë¯¸: GPT-Small + Basic
          - â— ìƒ‰ì¹ ëœ ë™ê·¸ë¼ë¯¸: GPT-Small + Guided
          - â— ë¹ˆ ë™ê·¸ë¼ë¯¸ + ë¹—ê¸ˆ: GPT-Smaller + Guided
          - â—‰ ìƒ‰ì¹ ëœ ë™ê·¸ë¼ë¯¸ + ë¹—ê¸ˆ: GPT-Large + Guided
        - **ë„¤ëª¨ (Claude ê³„ì—´)**:
          - â–¡ ë¹ˆ ë„¤ëª¨: Claude-Small + Basic
          - â–  ìƒ‰ì¹ ëœ ë„¤ëª¨: Claude-Small + Guided
          - â–¨ ë¹ˆ ë„¤ëª¨ + ë¹—ê¸ˆ: Claude-Smaller + Guided
          - â–© ìƒ‰ì¹ ëœ ë„¤ëª¨ + ë¹—ê¸ˆ: Claude-Large + Guided
        
        ### PSYCHE Score:
        - Xì¶•ì€ PSYCHE Score (0-55ì )ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
        - PSYCHE ScoreëŠ” **ì—°êµ¬ììš© Evaluation í˜ì´ì§€**ì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤
        - PACAì˜ constructì™€ SP(ground truth) constructë¥¼ PSYCHE RUBRIC ê¸°ì¤€ìœ¼ë¡œ ë¹„êµ í‰ê°€
        - ì ìˆ˜ê°€ ë†’ì„ìˆ˜ë¡ PACAì˜ ì„±ëŠ¥ì´ ìš°ìˆ˜í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤
        - ê° ëª¨ë¸-ì§ˆí™˜ ì¡°í•©ë§ˆë‹¤ 2ê°œì˜ ì‹¤í—˜ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤
        """)
    
    # Load data
    with st.spinner("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."):
        scores_data = load_psyche_scores(firebase_ref)
    
    # Debug: Show available keys if no data found
    if not scores_data:
        with st.expander("ğŸ” ë””ë²„ê¹…: Firebase í‚¤ í™•ì¸", expanded=False):
            try:
                all_data = firebase_ref.get()
                if all_data:
                    psyche_keys = [k for k in all_data.keys() if "_psyche_" in k]
                    if psyche_keys:
                        st.write(f"Found {len(psyche_keys)} PSYCHE evaluation keys:")
                        for key in sorted(psyche_keys):
                            st.code(key)
                    else:
                        st.write("No keys containing '_psyche_' found")
                        st.write("Sample keys from Firebase:")
                        for key in list(all_data.keys())[:10]:
                            st.code(key)
                else:
                    st.write("Firebase returned no data")
            except Exception as e:
                st.error(f"Error fetching keys: {e}")
    
    if not scores_data:
        st.warning("âš ï¸ ì•„ì§ í‰ê°€ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—°êµ¬ììš© ê²©ë¦¬í´ë”ì˜ Evaluation í˜ì´ì§€ì—ì„œ PSYCHE Scoreë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.")
        st.stop()
    
    # Display statistics
    st.markdown("### ğŸ“ˆ ìš”ì•½ í†µê³„")
    col1, col2, col3, col4 = st.columns(4)
    
    all_scores = [s['psyche_score'] for s in scores_data]
    
    with col1:
        st.metric("ê²€ì¦ ì™„ë£Œ", f"{len(scores_data)}/48")
    with col2:
        st.metric("í‰ê·  ì ìˆ˜", f"{sum(all_scores)/len(all_scores):.2f}")
    with col3:
        st.metric("ìµœê³  ì ìˆ˜", f"{max(all_scores):.2f}")
    with col4:
        st.metric("ìµœì € ì ìˆ˜", f"{min(all_scores):.2f}")
    
    st.markdown("---")
    
    # Create and display plot
    fig = create_psyche_plot(scores_data)
    st.pyplot(fig)
    
    # Detailed data table
    st.markdown("---")
    st.markdown("### ğŸ“‹ ìƒì„¸ ë°ì´í„°")
    
    df = pd.DataFrame(scores_data)
    df['model_name'] = df['model'].map(MODEL_NAMES)
    df = df[['disorder', 'model_name', 'client_num', 'exp_num', 'psyche_score']]
    df.columns = ['ì§ˆí™˜', 'ëª¨ë¸', 'Client ë²ˆí˜¸', 'Exp ë²ˆí˜¸', 'PSYCHE Score']
    df = df.sort_values(['ì§ˆí™˜', 'ëª¨ë¸', 'Client ë²ˆí˜¸', 'Exp ë²ˆí˜¸'])
    
    st.dataframe(df, use_container_width=True, hide_index=True)


if __name__ == "__main__":
    main()
